## Отладка драйверов при помощи VirtualKD ##

### Установка VirtualKD ###
  1. Создать виртуальную машину с предустановленной Windows 7 x32.
  1. Запустить виртуальную машину. Скопировать на ее жесткий диск архив с VirtualKD и распаковать его.
  1. Войти в папку VirtualKD-X.XX (где X.XX – версия)\target.
  1. Запустить vminstall. Программа создаст пункт в меню загрузки – загрузка с драйвером VirtualKD. В дальнейшем, для отладки, нужно загружаться этим пунктом.

### Отладка ###
  1. Из папки VirtualKD-X.XX (где X.XX – версия) на машине разработчика запустить программу vmmon.
  1. Запустить виртуальную машину с выбором режима отладки.
  1. При загрузке драйвер VirtualKD установит точку останова в начале загрузки. Система остановиться и будет ждать подключения отладчика.
  1. В vmmon выбрать из списка нужную машину (процесс).
  1. Выбрать нужный отладчик (windbg, kd).
  1. Выбрать автостарт отладчика, если требуется.
  1. Когда отладчик запустится – выполнить из него команду g или нажать F5 для продолжения загрузки.

ВАЖНО! Сообщения DbgPrint() фильтруются, и до WinDBG не доходят. Нужно что-то с этим сделать.

Также возможна отладка при помощи KD прямо из среды MSVS. Для этого нужно установить VisualDDK. После этого в меню отладки появится пункт «Start debugging driver».

> ### Сборка драйвера ###

1. Установить VisualDDK;
2. В файле sources перечислить библиотеки, необходимые для сборки и особые директивы компилятора. Например:

TARGETNAME=basic\_wfp
TARGETTYPE=DRIVER

INCLUDES=\
> $(DDK\_INC\_PATH);

TARGETLIBS=\
> $(DDK\_LIB\_PATH)\ntoskrnl.lib \
> $(DDK\_LIB\_PATH)\ndis.lib \
> $(DDK\_LIB\_PATH)\fwpkclnt.lib \
> $(SDK\_LIB\_PATH)\uuid.lib

C\_DEFINES=$(C\_DEFINES) -DBINARY\_COMPATIBLE=0 -DNT -DUNICODE -D\_UNICODE -DNDIS60 -DNDIS\_SUPPORT\_NDIS6

SOURCES=stdafx.cpp \
> basic\_wfp.cpp

Некоторые функции требуют включения заголовков в виде extern:


extern "C"
{
#include <ndis.h>
};
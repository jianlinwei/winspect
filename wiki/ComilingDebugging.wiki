#summary Сборка и отладка

Отладка драйверов при помощи VirtualKD

1. Установка VirtualKD
1.1 Создать виртуальную машину с предустановленной Windows 7 x32.
1.2 Запустить виртуальную машину. Скопировать на ее жесткий диск архив с VirtualKD и распаковать его.
1.3 Войти в папку VirtualKD-X.XX (где X.XX – версия)\target.
1.4 Запустить vminstall. Программа создаст пункт в меню загрузки – загрузка с драйвером VirtualKD. В дальнейшем, для отладки, нужно загружаться этим пунктом.

2. Отладка
2.1 Из папки VirtualKD-X.XX (где X.XX – версия) на машине разработчика запустить программу vmmon.
2.2 Запустить виртуальную машину с выбором режима отладки.
2.3 При загрузке драйвер VirtualKD установит точку останова в начале загрузки. Система остановиться и будет ждать подключения отладчика.
2.4 В vmmon выбрать из списка нужную машину (процесс).
2.5 Выбрать нужный отладчик (windbg, kd).
2.6 Выбрать автостарт отладчика, если требуется.
2.7 Когда отладчик запустится – выполнить из него команду g или нажать F5 для продолжения загрузки. 
ВАЖНО! Сообщения DbgPrint() фильтруются, и до WinDBG не доходят. Нужно что-то с этим сделать.

Также возможна отладка при помощи KD прямо из среды MSVS. Для этого нужно установить VisualDDK. После этого в меню отладки появится пункт «Start debugging driver».

 Сборка драйвера

1. Установить VisualDDK;
2. В файле sources перечислить библиотеки, необходимые для сборки и особые директивы компилятора. Например:

TARGETNAME=basic_wfp
TARGETTYPE=DRIVER

INCLUDES=\
   $(DDK_INC_PATH);

TARGETLIBS=\
    $(DDK_LIB_PATH)\ntoskrnl.lib \
    $(DDK_LIB_PATH)\ndis.lib \
    $(DDK_LIB_PATH)\fwpkclnt.lib \
    $(SDK_LIB_PATH)\uuid.lib

C_DEFINES=$(C_DEFINES) -DBINARY_COMPATIBLE=0 -DNT -DUNICODE -D_UNICODE -DNDIS60 -DNDIS_SUPPORT_NDIS6

SOURCES=stdafx.cpp \
	basic_wfp.cpp

Некоторые функции требуют включения заголовков в виде extern:

 
extern "C"
{
#include <ndis.h>
};
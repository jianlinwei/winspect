
== Отладка драйверов при помощи VirtualKD ==

=== Установка VirtualKD ===
  # Создать виртуальную машину с предустановленной Windows 7 x32.
  # Запустить виртуальную машину. Скопировать на ее жесткий диск архив с VirtualKD и распаковать его.
  # Войти в папку VirtualKD-X.XX (где X.XX – версия)\target.
  # Запустить vminstall. Программа создаст пункт в меню загрузки – загрузка с драйвером VirtualKD. В дальнейшем, для отладки, нужно загружаться этим пунктом.

=== Отладка ===
  # Из папки VirtualKD-X.XX (где X.XX – версия) на машине разработчика запустить программу vmmon.
  # Запустить виртуальную машину с выбором режима отладки.
  # При загрузке драйвер VirtualKD установит точку останова в начале загрузки. Система остановиться и будет ждать подключения отладчика.
  # В vmmon выбрать из списка нужную машину (процесс).
  # Выбрать нужный отладчик (windbg, kd).
  # Выбрать автостарт отладчика, если требуется.
  # Когда отладчик запустится – выполнить из него команду g или нажать F5 для продолжения загрузки. 

ВАЖНО! Сообщения DbgPrint() фильтруются, и до WinDBG не доходят. Нужно что-то с этим сделать.

Также возможна отладка при помощи KD прямо из среды MSVS. Для этого нужно установить VisualDDK. После этого в меню отладки появится пункт «Start debugging driver».

 === Сборка драйвера ===

1. Установить VisualDDK;
2. В файле sources перечислить библиотеки, необходимые для сборки и особые директивы компилятора. Например:

TARGETNAME=basic_wfp
TARGETTYPE=DRIVER

INCLUDES=\
   $(DDK_INC_PATH);

TARGETLIBS=\
    $(DDK_LIB_PATH)\ntoskrnl.lib \
    $(DDK_LIB_PATH)\ndis.lib \
    $(DDK_LIB_PATH)\fwpkclnt.lib \
    $(SDK_LIB_PATH)\uuid.lib

C_DEFINES=$(C_DEFINES) -DBINARY_COMPATIBLE=0 -DNT -DUNICODE -D_UNICODE -DNDIS60 -DNDIS_SUPPORT_NDIS6

SOURCES=stdafx.cpp \
	basic_wfp.cpp

Некоторые функции требуют включения заголовков в виде extern:

 
extern "C"
{
#include <ndis.h>
};